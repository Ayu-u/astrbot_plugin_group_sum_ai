# 群聊消息自动总结插件使用说明

## 功能介绍

群聊消息自动总结插件能够自动收集微信群聊中的消息，并在达到设定的消息数量阈值后，使用大模型自动总结群聊内容，提取重要信息和主要话题。总结结果可以保存在本地文件中，也可以根据配置发送到群聊中。

### 主要功能

1. **自动总结**：当群聊消息达到设定阈值且满足时间间隔时，自动总结群聊内容
2. **手动总结**：支持管理员手动触发总结，可指定总结消息数量
3. **数据自动清理**：自动清理旧的总结文件，节约存储空间
4. **总结内容发送**：可将总结结果发送到当前群聊或指定的群聊
5. **自定义提示词**：支持通过外部文件自定义详细的提示词，优化总结效果

## 快速上手

### 安装方法

1. 确保 AstrBot 已正确安装并运行
2. 将整个 `group-summarizer` 文件夹放入 AstrBot 的 `data/plugins/` 目录下
3. 重启 AstrBot，插件将自动加载

### 基本使用

插件加载后会自动开始收集群聊消息，无需任何手动操作。当某个群的消息累计达到阈值（默认300条）且距离上次总结时间超过设定间隔（默认1小时）后，插件会自动进行总结。

### 可用命令

在群聊中可以使用以下命令：

- `/summary_status` - 查看当前群的消息收集状态，包括已收集消息数量和上次总结时间
- `/summarize_now` - 立即对当前收集的所有消息进行总结（仅管理员可用）
- `/summary [数量]` - 立即总结最近指定数量的消息（仅管理员可用，不会重置计数器）
- `/summary_help` - 显示插件帮助信息

### 总结结果查看

总结结果会根据配置：
1. 保存在 `data/group_summaries/` 目录下，文件名格式为：`群ID_日期_时间.txt`
2. 如果配置了发送选项，还会将总结内容发送到当前群聊或指定的群聊

总结文件内容包括：
- 群名称和群ID
- 总结时间
- 总结的消息数量
- 详细的总结内容

## 插件配置

群聊消息总结插件提供多种配置方式，可以根据需要选择使用：

### 方式一：YAML配置文件（推荐）

最推荐的配置方式是直接编辑插件目录下的 `config.yaml` 文件。示例配置：

```yaml
# 触发总结的消息数量阈值
summary_threshold: 300

# 每个群消息缓冲区最大容量
max_buffer_size: 500

# 两次总结之间的最小时间间隔(秒)，默认1小时
min_interval: 3600

# 是否使用外部提示词文件
use_external_prompts: true

# 数据自动清理设置
data_cleaning:
  # 是否启用自动清理
  enabled: true
  # 清理检查周期(秒)，默认24小时检查一次
  check_interval: 86400
  # 保留总结文件的最大数量(每个群)，超过则删除最旧的
  max_files_per_group: 30
  # 保留总结文件的最长时间(天)，超过则删除
  max_retention_days: 30

# 总结发送设置
sending:
  # 是否将总结发送到群聊
  send_to_chat: false
  # 发送目标设置
  target:
    # 发送目标类型: "current" - 当前群聊, "custom" - 自定义群聊
    type: "current"
    # 自定义目标群ID，当type为"custom"时生效
    custom_group_id: ""
    # 当发送到自定义群聊时，是否在消息前添加原群名称
    add_group_name_prefix: true
```

### 方式二：AstrBot管理面板

您可以在AstrBot管理面板的插件页面找到该插件，点击"管理"，然后点击"配置"进行设置。

### 方式三：全局配置文件

如需手动配置，也可以在 AstrBot 配置文件中添加对应的配置项。

## 数据自动清理

插件支持自动清理旧的总结文件，避免占用过多存储空间：

1. **按数量清理**：为每个群保留最近的N个总结文件，超过则删除最旧的
2. **按时间清理**：删除超过指定天数的总结文件

这些设置可以在`config.yaml`的`data_cleaning`部分进行配置：
- `enabled`: 是否启用自动清理功能
- `check_interval`: 清理检查周期(秒)
- `max_files_per_group`: 每个群保留的最大文件数
- `max_retention_days`: 文件保留的最长天数

## 总结发送设置

插件支持将总结结果发送到群聊中：

1. **发送开关**：配置是否发送总结结果
2. **发送目标**：可以选择发送到当前群聊或指定的自定义群聊
3. **群名前缀**：当发送到自定义群聊时，可以选择是否在消息前添加原群名称

这些设置可以在`config.yaml`的`sending`部分进行配置：
- `send_to_chat`: 是否将总结发送到群聊
- `target.type`: 发送目标类型（"current"或"custom"）
- `target.custom_group_id`: 自定义目标群ID
- `target.add_group_name_prefix`: 是否添加原群名称前缀

## 自定义提示词

插件支持自定义提示词，可通过编辑插件目录下的 `prompts.py` 文件进行修改。

该文件包含以下提示词定义：

1. **SYSTEM_PROMPT**：系统提示词，指导AI总结的风格和方向
2. **SUMMARY_PROMPT_TEMPLATE**：消息总结提示词模板
3. **MESSAGE_FORMAT**：单条消息格式模板
4. **FEW_MESSAGES_PROMPT**：消息数量过少时的额外提示词

这种设计允许您根据需要编写非常详细的提示词，而不必担心插件代码变得复杂。

## 常见问题

**Q: 为什么我的群聊没有自动总结？**
A: 可能是因为消息数量未达到阈值或者距离上次总结时间未超过设定间隔。您可以使用 `/summary_status` 命令查看当前状态。

**Q: 总结结果在哪里可以看到？**
A: 总结结果默认保存在 `data/group_summaries/` 目录下的文本文件中。如果配置了发送选项，还会发送到指定的群聊中。

**Q: 如何更改总结的消息数量阈值？**
A: 在插件配置页面修改"触发总结阈值"，或修改`config.yaml`文件中的`summary_threshold`值。

**Q: 如何立即总结当前群聊的内容？**
A: 管理员可以使用 `/summarize_now` 命令立即总结当前群聊已收集的所有消息，或使用 `/summary [数量]` 命令总结最近指定数量的消息。

**Q: 如何配置总结结果发送到指定群聊？**
A: 修改`config.yaml`文件中的`sending`部分，设置`send_to_chat`为`true`，`target.type`为`custom`，并在`target.custom_group_id`中填写目标群ID。

**Q: 如何防止总结文件占用过多空间？**
A: 配置`data_cleaning`部分，设置`enabled`为`true`，并设置适当的`max_files_per_group`和`max_retention_days`值。

**Q: 如何使用自己的提示词？**
A: 编辑插件目录下的 `prompts.py` 文件，修改对应的提示词变量。确保 `config.yaml` 中的 `use_external_prompts` 设置为 `true`。
